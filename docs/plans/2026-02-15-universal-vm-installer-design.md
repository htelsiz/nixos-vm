# Universal NixOS VM Installer — Design

## Goal

Repurpose the existing `nixos-vm` repo (currently locked to aarch64-linux / QEMU)
into a universal NixOS VM installer that works on **any VM platform** (Parallels,
UTM, QEMU/KVM, VirtualBox, VMware) on **both aarch64-linux and x86_64-linux**.

## Architecture

### Repo Structure

```
nixos-vm/
├── flake.nix                  # Dual-arch configs, disko + home-manager inputs
├── flake.lock
├── configuration.nix          # System config (parameterized hostname/username)
├── home.nix                   # Home-manager config (parameterized username)
├── disko-config.nix           # Declarative disk layout (GPT + ESP + ext4)
├── disk-device.nix            # Generated at install time — disk path for disko
├── install.sh                 # Interactive installer
├── docs/
│   └── plans/
│       └── 2026-02-15-universal-vm-installer-design.md
└── README.md
```

### Flake Design

**Inputs**: `nixpkgs` (nixos-unstable), `home-manager`, `disko`

**Outputs**: A `mkHost` helper function parameterized by `{ system, hostname, username }`:

- `nixosConfigurations.nixvm-aarch64` — ARM64 (Apple Silicon VMs: UTM, Parallels)
- `nixosConfigurations.nixvm-x86_64` — x86_64 (QEMU/KVM, VirtualBox, VMware)

Both configs include disko and home-manager as NixOS modules.
`specialArgs` passes `hostname` and `username` so `configuration.nix` and `home.nix`
can reference them without hardcoding.

### Disko Config

Declares a simple VM disk layout:

- **GPT** partition table
- **Partition 1**: 512 MB EFI System Partition (FAT32, label `boot`)
- **Partition 2**: Rest of disk as ext4 (label `nixos`)
- **Disk device**: Read from `disk-device.nix` (generated by installer)

The disk device path is injected via a generated Nix file rather than environment
variables, preserving flake purity.

### Configuration

`configuration.nix` changes from current:

- Removes hardcoded `boot.loader.*` (disko handles this)
- Removes hardcoded `fileSystems` and `swapDevices` (disko handles these)
- Uses `hostname` from `specialArgs` instead of hardcoded `phoenix-vm`
- Uses `username` from `specialArgs` instead of hardcoded `ht`
- Keeps all packages, services, desktop environment (KDE Plasma, Docker, Tailscale,
  1Password, etc.)

`home.nix` changes:

- Uses `username` from args instead of hardcoded `ht`

### Hardware Configuration

`hardware-configuration.nix` is **not shipped** — generated at install time via
`nixos-generate-config --root /mnt`.

**Critical**: The generated file will contain `fileSystems` and `swapDevices` blocks
that conflict with disko's declarations. The installer **must strip** these sections,
keeping only:

- `boot.initrd.availableKernelModules` (hypervisor-specific drivers)
- `boot.initrd.kernelModules`
- `boot.kernelModules`
- `boot.extraModulePackages`
- `nixpkgs.hostPlatform` (if present)

## Interactive Installer Flow

```
install.sh
│
├─ 1. Check prerequisites (root, network connectivity)
├─ 2. Detect architecture (uname -m → aarch64-linux or x86_64-linux)
├─ 3. Enforce EFI boot mode
│     └─ Check /sys/firmware/efi/efivars exists
│     └─ If missing: hard-fail with "Enable EFI/UEFI in VM settings"
├─ 4. List available disks
│     └─ lsblk -d -n -o NAME,SIZE,TYPE | filter TYPE=disk, exclude RM=1/RO=1
├─ 5. Prompt: select disk (numbered list)
├─ 6. Confirm: "THIS WILL ERASE ALL DATA on /dev/XXX (YYG). Continue? [y/N]"
├─ 7. Prompt: hostname (default: nixvm)
├─ 8. Prompt: username (default: ht)
├─ 9. Clone repo to /mnt/etc/nixos (via git)
├─ 10. Write disk-device.nix with selected disk path
├─ 11. Run disko (partition + format + mount to /mnt)
├─ 12. Run nixos-generate-config --root /mnt --dir /mnt/etc/nixos
├─ 13. Strip fileSystems/swapDevices from generated hardware-configuration.nix
├─ 14. git init + git add . in /mnt/etc/nixos (flakes require git repo)
├─ 15. Run nixos-install --flake /mnt/etc/nixos#nixvm-{arch}
├─ 16. Set user password via nixos-enter --root /mnt -c 'passwd {username}'
└─ 17. Done — prompt to reboot
```

### Safety Guardrails

- **EFI enforcement**: Refuse to proceed on BIOS-booted VMs
- **Disk filtering**: Exclude ROM, removable, read-only devices
- **Destructive confirmation**: Explicit "ERASE ALL DATA" prompt before disko runs
- **Network check**: Verify connectivity before git clone attempt
- **Password**: Set via `nixos-enter` post-install (avoids `mkpasswd` availability issues)

## What Stays the Same

All packages, services, and desktop environment from the current config:

- KDE Plasma 6 desktop
- Docker, Tailscale, 1Password
- Git, zsh, home-manager config
- All system packages

## Consensus

Validated by multi-model consensus (Gemini 2.5 Pro, GPT 5.2, Gemini 3 Pro Preview).
Overall confidence: **High** (9/10, 8/10, 9/10).

Key risks identified and mitigated:

1. Disko/hardware-config `fileSystems` conflict → strip from generated config
2. Flake purity vs runtime disk device → `disk-device.nix` injection
3. EFI-only on x86_64 → hard-fail with clear message if BIOS detected
4. Disk detection safety → filter + explicit confirmation
5. Flake git requirement → `git init && git add .` before install
